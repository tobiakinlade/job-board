name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to rollback'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
      commit_sha:
        description: 'Git commit SHA to rollback to (7 chars)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      is-valid: ${{ steps.check.outputs.valid }}
      backend-tag: ${{ steps.check.outputs.backend_tag }}
      frontend-tag: ${{ steps.check.outputs.frontend_tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit and extract tags
        id: check
        run: |
          COMMIT=${{ inputs.commit_sha }}

          if ! git cat-file -e ${COMMIT} 2>/dev/null; then
            echo "::error::Commit ${COMMIT} not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          git show ${COMMIT}:kubernetes/overlays/dev/kustomization.yaml > /tmp/old.yaml

          BACKEND_TAG=$(grep -A2 "backend-placeholder" /tmp/old.yaml | grep newTag | awk '{print $2}')
          FRONTEND_TAG=$(grep -A2 "frontend-placeholder" /tmp/old.yaml | grep newTag | awk '{print $2}')

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "backend_tag=${BACKEND_TAG}" >> $GITHUB_OUTPUT
          echo "frontend_tag=${FRONTEND_TAG}" >> $GITHUB_OUTPUT

  rollback:
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.is-valid == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply rollback
        run: |
          COMPONENT=${{ inputs.component }}
          FILE=kubernetes/overlays/dev/kustomization.yaml
          BACKEND=${{ needs.validate.outputs.backend-tag }}
          FRONTEND=${{ needs.validate.outputs.frontend-tag }}

          if [ "$COMPONENT" = "backend" ] || [ "$COMPONENT" = "both" ]; then
            sed -i.bak "/backend-placeholder/,/newTag:/ s/newTag: .*/newTag: ${BACKEND}/" $FILE
          fi

          if [ "$COMPONENT" = "frontend" ] || [ "$COMPONENT" = "both" ]; then
            sed -i.bak "/frontend-placeholder/,/newTag:/ s/newTag: .*/newTag: ${FRONTEND}/" $FILE
          fi

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add kubernetes/overlays/dev/kustomization.yaml
          git commit -m "⏮️ Rollback ${{ inputs.component }} to ${{
            inputs.commit_sha }} - ${{
            inputs.reason }}"
          git push origin main

      - name: Wait for ArgoCD
        run: |
          echo "Waiting for ArgoCD sync..."
          sleep 30
