name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      component:
        description: 'Component to rollback'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - all
      deployment_timestamp:
        description: 'Deployment timestamp to rollback to (YYYY-MM-DD-HH-MM-SS) - leave empty to list recent deployments'
        required: false
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  list-deployments:
    name: List Available Deployments
    runs-on: ubuntu-latest
    if: inputs.deployment_timestamp == ''
    
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
      
      - name: List recent deployments
        run: |
          ENV="${{ inputs.environment }}"
          COMPONENT="${{ inputs.component }}"
          HISTORY_DIR="deployments/history/${ENV}"
          
          echo "## Recent Deployments for ${COMPONENT} in ${ENV}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | Component | Image Tag | Actor | Commit |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----------|-----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # List last 10 deployments
          for dir in $(ls -t ${HISTORY_DIR} | head -10); do
            if [ -f "${HISTORY_DIR}/${dir}/metadata.json" ]; then
              TIMESTAMP=$(jq -r '.timestamp' ${HISTORY_DIR}/${dir}/metadata.json)
              COMP=$(jq -r '.component' ${HISTORY_DIR}/${dir}/metadata.json)
              IMAGE=$(jq -r '.image_tag' ${HISTORY_DIR}/${dir}/metadata.json)
              ACTOR=$(jq -r '.actor' ${HISTORY_DIR}/${dir}/metadata.json)
              COMMIT=$(jq -r '.commit_sha' ${HISTORY_DIR}/${dir}/metadata.json | cut -c1-7)
              
              if [ "${COMPONENT}" = "all" ] || [ "${COMP}" = "${COMPONENT}" ]; then
                echo "| ${TIMESTAMP} | ${COMP} | ${IMAGE} | ${ACTOR} | ${COMMIT} |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To rollback, re-run this workflow with a deployment timestamp from above.**" >> $GITHUB_STEP_SUMMARY
  
  validate-rollback:
    name: Validate Rollback
    runs-on: ubuntu-latest
    if: inputs.deployment_timestamp != ''
    outputs:
      is-valid: ${{ steps.validate.outputs.valid }}
    
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
      
      - name: Validate deployment timestamp
        id: validate
        run: |
          ENV="${{ inputs.environment }}"
          TIMESTAMP="${{ inputs.deployment_timestamp }}"
          ARTIFACT_DIR="deployments/history/${ENV}/${TIMESTAMP}"
          
          if [ ! -d "${ARTIFACT_DIR}" ]; then
            echo "::error::Deployment ${TIMESTAMP} not found in ${ENV}"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ ! -f "${ARTIFACT_DIR}/metadata.json" ]; then
            echo "::error::Metadata file not found for deployment ${TIMESTAMP}"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ ! -f "${ARTIFACT_DIR}/values.yaml" ]; then
            echo "::error::Values file not found for deployment ${TIMESTAMP}"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "âœ… Deployment artifact validated" >> $GITHUB_STEP_SUMMARY
      
      - name: Display rollback details
        run: |
          ENV="${{ inputs.environment }}"
          TIMESTAMP="${{ inputs.deployment_timestamp }}"
          ARTIFACT_DIR="deployments/history/${ENV}/${TIMESTAMP}"
          
          echo "## Rollback Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${ENV}" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${{ inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Deployment:** ${TIMESTAMP}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Initiated by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Original Deployment Metadata" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat ${ARTIFACT_DIR}/metadata.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  perform-rollback:
    name: Perform Rollback
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: inputs.deployment_timestamp != '' && needs.validate-rollback.outputs.is-valid == 'true'
    
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_PAT }}
      
      - name: Setup yq
        uses: mikefarah/yq@master
      
      - name: Restore configuration from artifact
        id: restore
        run: |
          ENV="${{ inputs.environment }}"
          COMPONENT="${{ inputs.component }}"
          TIMESTAMP="${{ inputs.deployment_timestamp }}"
          ARTIFACT_DIR="deployments/history/${ENV}/${TIMESTAMP}"
          CURRENT_VALUES="environments/${ENV}/values.yaml"
          
          # Backup current values
          BACKUP_DIR="deployments/history/${ENV}/backup-$(date -u +%Y-%m-%d-%H-%M-%S)"
          mkdir -p ${BACKUP_DIR}
          cp ${CURRENT_VALUES} ${BACKUP_DIR}/values.yaml
          echo "Current configuration backed up to ${BACKUP_DIR}"
          
          # Restore from artifact
          if [ "${COMPONENT}" = "all" ]; then
            echo "Restoring full configuration..."
            cp ${ARTIFACT_DIR}/values.yaml ${CURRENT_VALUES}
          else
            echo "Restoring ${COMPONENT} configuration..."
            
            # Extract component-specific values and merge
            IMAGE_REPO=$(yq eval ".${COMPONENT}.image.repository" ${ARTIFACT_DIR}/values.yaml)
            IMAGE_TAG=$(yq eval ".${COMPONENT}.image.tag" ${ARTIFACT_DIR}/values.yaml)
            
            yq eval ".${COMPONENT}.image.repository = \"${IMAGE_REPO}\"" -i ${CURRENT_VALUES}
            yq eval ".${COMPONENT}.image.tag = \"${IMAGE_TAG}\"" -i ${CURRENT_VALUES}
          fi
          
          # Add rollback annotations
          ROLLBACK_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          yq eval ".${COMPONENT}.annotations.\"rollback.timestamp\" = \"${ROLLBACK_TIMESTAMP}\"" -i ${CURRENT_VALUES}
          yq eval ".${COMPONENT}.annotations.\"rollback.from\" = \"${TIMESTAMP}\"" -i ${CURRENT_VALUES}
          yq eval ".${COMPONENT}.annotations.\"rollback.reason\" = \"${{ inputs.reason }}\"" -i ${CURRENT_VALUES}
          yq eval ".${COMPONENT}.annotations.\"rollback.actor\" = \"${{ github.actor }}\"" -i ${CURRENT_VALUES}
          
          echo "Configuration restored successfully"
      
      - name: Create rollback artifact
        run: |
          ENV="${{ inputs.environment }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d-%H-%M-%S")
          ROLLBACK_DIR="deployments/history/${ENV}/rollback-${TIMESTAMP}"
          mkdir -p ${ROLLBACK_DIR}
          
          # Save rollback metadata
          cat > ${ROLLBACK_DIR}/metadata.json << EOF
          {
            "type": "rollback",
            "timestamp": "${TIMESTAMP}",
            "environment": "${ENV}",
            "component": "${{ inputs.component }}",
            "rolled_back_to": "${{ inputs.deployment_timestamp }}",
            "reason": "${{ inputs.reason }}",
            "actor": "${{ github.actor }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF
          
          # Save restored values
          cp environments/${ENV}/values.yaml ${ROLLBACK_DIR}/values.yaml
          
          # Create rollback summary
          echo "# Rollback Summary" > ${ROLLBACK_DIR}/README.md
          echo "" >> ${ROLLBACK_DIR}/README.md
          echo "**Type:** Rollback" >> ${ROLLBACK_DIR}/README.md
          echo "**Environment:** ${ENV}" >> ${ROLLBACK_DIR}/README.md
          echo "**Component:** ${{ inputs.component }}" >> ${ROLLBACK_DIR}/README.md
          echo "**Rolled back to:** ${{ inputs.deployment_timestamp }}" >> ${ROLLBACK_DIR}/README.md
          echo "**Reason:** ${{ inputs.reason }}" >> ${ROLLBACK_DIR}/README.md
          echo "**Actor:** ${{ github.actor }}" >> ${ROLLBACK_DIR}/README.md
          echo "**Timestamp:** ${TIMESTAMP}" >> ${ROLLBACK_DIR}/README.md
      
      - name: Commit and push rollback
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add environments/${{ inputs.environment }}/values.yaml
          git add deployments/history/
          
          git commit -m "â®ï¸ Rollback ${{ inputs.component }} in ${{ inputs.environment }}
          
          Rolled back to: ${{ inputs.deployment_timestamp }}
          Component: ${{ inputs.component }}
          Reason: ${{ inputs.reason }}
          Actor: ${{ github.actor }}
          
          This rollback was triggered manually via GitHub Actions."
          
          git push origin main
      
      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting 30 seconds for ArgoCD to detect changes..."
          sleep 30
          echo "ArgoCD should now be syncing the rollback"
      
      - name: Create rollback summary
        run: |
          echo "## âœ… Rollback Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${{ inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to:** ${{ inputs.deployment_timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor ArgoCD for sync completion" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify application health in cluster" >> $GITHUB_STEP_SUMMARY
          echo "3. Check application functionality" >> $GITHUB_STEP_SUMMARY
          echo "4. Investigate root cause of the issue" >> $GITHUB_STEP_SUMMARY
      
      - name: Create GitHub Issue for rollback
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## ðŸ”„ Rollback Performed\n\n` +
                        `**Environment:** ${{ inputs.environment }}\n` +
                        `**Component:** ${{ inputs.component }}\n` +
                        `**Rolled back to:** ${{ inputs.deployment_timestamp }}\n` +
                        `**Reason:** ${{ inputs.reason }}\n` +
                        `**Actor:** ${{ github.actor }}\n\n` +
                        `### Post-Rollback Actions\n` +
                        `- [ ] Verify application health\n` +
                        `- [ ] Investigate root cause\n` +
                        `- [ ] Create fix and test\n` +
                        `- [ ] Document incident\n\n` +
                        `**Workflow:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Rollback: ${{ inputs.component }} in ${{ inputs.environment }}`,
              body: body,
              labels: ['rollback', '${{ inputs.environment }}', 'incident']
            });
  
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: perform-rollback
    if: always()
    
    steps:
      - name: Notify Slack on rollback
        if: needs.perform-rollback.result == 'success'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸ”„ Rollback performed in ${{ inputs.environment }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ”„ Deployment Rollback"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ inputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Component:*\n${{ inputs.component }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Rolled back to:*\n${{ inputs.deployment_timestamp }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Actor:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Reason:* ${{ inputs.reason }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Monitor in ArgoCD"
                      },
                      "url": "https://argocd.example.com/applications/job-board-${{ inputs.environment }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
