name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to rollback'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
      commit_sha:
        description: 'Git commit SHA to rollback to (7 characters)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  validate:
    name: Validate Rollback Target
    runs-on: ubuntu-latest
    outputs:
      is-valid: ${{ steps.check.outputs.valid }}
      backend-tag: ${{ steps.check.outputs.backend_tag }}
      frontend-tag: ${{ steps.check.outputs.frontend_tag }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit exists
        id: check
        run: |
          COMMIT="${{ inputs.commit_sha }}"
          
          if ! git cat-file -e ${COMMIT} 2>/dev/null; then
            echo "::error::Commit ${COMMIT} not found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          git show ${COMMIT}:kubernetes/overlays/dev/kustomization.yaml > /tmp/old-kustomization.yaml
          
          BACKEND_TAG=$(grep -A 2 "name: backend-placeholder" /tmp/old-kustomization.yaml | grep "newTag:" | awk '{print $2}')
          FRONTEND_TAG=$(grep -A 2 "name: frontend-placeholder" /tmp/old-kustomization.yaml | grep "newTag:" | awk '{print $2}')
          
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "backend_tag=${BACKEND_TAG}" >> $GITHUB_OUTPUT
          echo "frontend_tag=${FRONTEND_TAG}" >> $GITHUB_OUTPUT
          
          echo "## Rollback Target Validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${COMMIT}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Tag:** ${BACKEND_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Tag:** ${FRONTEND_TAG}" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Perform Rollback
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.is-valid == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Update image tags for rollback
        run: |
          COMPONENT="${{ inputs.component }}"
          BACKEND_TAG="${{ needs.validate.outputs.backend-tag }}"
          FRONTEND_TAG="${{ needs.validate.outputs.frontend-tag }}"
          KUSTOMIZATION="kubernetes/overlays/dev/kustomization.yaml"
          
          echo "Current kustomization.yaml:"
          cat ${KUSTOMIZATION}
          
          if [ "${COMPONENT}" = "backend" ] || [ "${COMPONENT}" = "both" ]; then
            echo "Rolling back backend to: ${BACKEND_TAG}"
            sed -i.bak "/name: backend-placeholder/,/newTag:/ s/newTag: .*/newTag: ${BACKEND_TAG}/" ${KUSTOMIZATION}
          fi
          
          if [ "${COMPONENT}" = "frontend" ] || [ "${COMPONENT}" = "both" ]; then
            echo "Rolling back frontend to: ${FRONTEND_TAG}"
            sed -i.bak "/name: frontend-placeholder/,/newTag:/ s/newTag: .*/newTag: ${FRONTEND_TAG}/" ${KUSTOMIZATION}
          fi
          
          echo ""
          echo "Updated kustomization.yaml:"
          cat ${KUSTOMIZATION}
      
      - name: Commit and push rollback
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add kubernetes/overlays/dev/kustomization.yaml
          
          git commit -m "â®ï¸ Rollback: ${{ inputs.component }} to commit ${{ inputs.commit_sha }}
          
          Reason: ${{ inputs.reason }}
          Actor: ${{ github.actor }}
          Component: ${{ inputs.component }}
          Target Commit: ${{ inputs.commit_sha }}
          
          Backend Tag: ${{ needs.validate.outputs.backend-tag }}
          Frontend Tag: ${{ needs.validate.outputs.frontend-tag }}"
          
          git push origin main
      
      - name: Wait for ArgoCD sync
        run: |
          echo "â³ Waiting for ArgoCD to detect changes..."
          sleep 30
          echo "âœ… ArgoCD should now be syncing the rollback"
      
      - name: Create rollback summary
        run: |
          echo "## âœ… Rollback Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** ${{ inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Commit:** ${{ inputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Tag:** ${{ needs.validate.outputs.backend-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Tag:** ${{ needs.validate.outputs.frontend-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verify Rollback" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n job-board" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get deployment frontend -n job-board -o jsonpath='{.spec.template.spec.containers[0].image}'" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## ðŸ”„ Rollback Performed\n\n` +
                        `**Component:** ${{ inputs.component }}\n` +
                        `**Target Commit:** ${{ inputs.commit_sha }}\n` +
                        `**Backend Tag:** ${{ needs.validate.outputs.backend-tag }}\n` +
                        `**Frontend Tag:** ${{ needs.validate.outputs.frontend-tag }}\n` +
                        `**Reason:** ${{ inputs.reason }}\n` +
                        `**Actor:** ${{ github.actor }}\n\n` +
                        `### Post-Rollback Checklist\n` +
                        `- [ ] Verify application health\n` +
                        `- [ ] Check logs for errors\n` +
                        `- [ ] Investigate root cause\n` +
                        `- [ ] Create fix and test\n` +
                        `- [ ] Document incident\n\n` +
                        `**Workflow:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Rollback: ${{ inputs.component }} to ${{ inputs.commit_sha }}`,
              body: body,
              labels: ['rollback', 'incident']
            });
