apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: job-board-alerts
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
    - name: job-board.rules
      rules:
        # Pod not ready
        - alert: JobBoardPodNotReady
          expr: |
            kube_pod_status_ready{namespace="job-board", condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.pod }} not ready"
            description: "Pod has been not ready for more than 5 minutes"

        # Pod restarting frequently
        - alert: JobBoardPodRestartingFrequently
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="job-board"}[1h]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.pod }} restarting frequently"
            description: "Pod has restarted {{ $value }} times in the last hour"

        # High memory usage
        - alert: JobBoardHighMemoryUsage
          expr: |
            (container_memory_usage_bytes{namespace="job-board"} / container_spec_memory_limit_bytes{namespace="job-board"}) > 0.85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage on {{ $labels.pod }}"
            description: "Memory usage is above 85%"

        # High CPU usage
        - alert: JobBoardHighCPUUsage
          expr: |
            (rate(container_cpu_usage_seconds_total{namespace="job-board"}[5m]) * 100) > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on {{ $labels.pod }}"
            description: "CPU usage is above 80%"

        # Deployment replicas mismatch
        - alert: JobBoardDeploymentReplicasMismatch
          expr: |
            kube_deployment_spec_replicas{namespace="job-board"} != kube_deployment_status_replicas_available{namespace="job-board"}
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Deployment {{ $labels.deployment }} replicas mismatch"
            description: "Expected {{ $value }} replicas but some are unavailable"

        # PVC almost full
        - alert: JobBoardPVCAlmostFull
          expr: |
            (kubelet_volume_stats_used_bytes{namespace="job-board"} / kubelet_volume_stats_capacity_bytes{namespace="job-board"}) > 0.85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} almost full"
            description: "PVC is {{ $value | humanizePercentage }} full"

    - name: job-board.slo
      rules:
        # SLI: Availability recording rule
        - record: job_board:availability:rate5m
          expr: |
            sum(rate(kube_pod_status_ready{namespace="job-board", condition="true"}[5m]))
            / sum(rate(kube_pod_status_ready{namespace="job-board"}[5m]))

        # SLO: 99.9% availability target
        - alert: JobBoardSLOAvailabilityBreach
          expr: |
            (1 - job_board:availability:rate5m) > 0.001
          for: 5m
          labels:
            severity: critical
            slo: availability
          annotations:
            summary: "Job Board availability SLO breach"
            description: "Availability is below 99.9% target"
